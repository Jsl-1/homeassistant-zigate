<dom-module id='ha-panel-zigate'>
    <template>
      <style include="ha-style">
        #zigatenetworkmap { height: calc(100vh - 64px); width: 100%; }
      </style>
      <app-header-layout has-scrolling-region>
        <app-header slot="header" fixed>
          <app-toolbar>
            <ha-menu-button narrow='[[narrow]]' show-menu='[[showMenu]]'></ha-menu-button>
            <div main-title>ZiGate Graph</div>
            <paper-menu-button role="group" horizontal-align="right">
              <paper-icon-button icon="hass:dots-vertical" slot="dropdown-trigger"></paper-icon-button>
              <paper-listbox slot="dropdown-content">
                <paper-item id="menuItemRefresh">Update Graph</paper-item>
                <paper-item id="menuItemNetworkTable">Generate network table</paper-item>
                <paper-item id="menuItemPermitJoin">Permit Join</paper-item>
              </paper-listbox>
            </paper-menu-button>
          </app-toolbar>
        </app-header>
        <div id="zigatenetworkmap"></div>
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.css" />
      </app-header-layout>
    </template>
  </dom-module>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.js"></script>
  <script>
    class HaPanelZiGate extends Polymer.Element {
      static get is() { return 'ha-panel-zigate'; }

      static get properties() {
        return {
          // Home Assistant object
          hass: Object,
          // If should render in narrow mode
          narrow: {
            type: Boolean,
            value: false,
          },
          // If sidebar is currently shown
          showMenu: {
            type: Boolean,
            value: false,
          },
          // Home Assistant panel info99
          // panel.config contains config passed to register_panel serverside
          panel: Object,
        };
      }

      ready() {
        super.ready();


        let dataSetOptions = { queue: true };
        this._nodesDataset = new vis.DataSet([], dataSetOptions);
        this._edgesDataset = new vis.DataSet([], dataSetOptions);
        
        this.$.menuItemRefresh.addEventListener('click', this.menuItemRefreshClick.bind(this));
        this.$.menuItemNetworkTable.addEventListener('click', this.menuItemNetworkTableClick.bind(this));
        this.$.menuItemPermitJoin.addEventListener('click', this.menuItemPermitJoinClick.bind(this));
        
        this.initGraphOptions();
        this.initNetworkGraph();   
        this.refreshData();  
           
      }

      menuItemRefreshClick() {
        this.refreshData();
      }

      menuItemNetworkTableClick() {
        this.hass
          .callService('zigate', 'build_network_table', {})
          .then(this.refreshData.bind(this));
      }

      menuItemPermitJoinClick() {
        this.hass.callService('zigate', 'permit_join', {});          
      }

      initGraphOptions(){
        this._graphOptions = {
          physics: false,
          autoResize: true,
          width: '100%',
          height: '100%',
          nodes: {
            shape: 'box'
          },
          edges: {
            smooth: false
            ,scaling: { label: false, max: 10 }
           // smooth: { enabled: true, type: 'dynamic'}
          },
          layout: {
            randomSeed: 0,
          },
          interaction: {
            hover: true,
          }
        };
        
        this._zigateNodeOptions = {
        	  shape: 'ellipse'
        };
        
        this._missingNodeOptions = {
        	  color: 'red'
        };

        let customGraphOptions = this.panel.config['graph'];
        if(typeof(customGraphOptions) === 'Object')
          this._graphOptions = Object.assign(this._graphOptions, customGraphOptions);

	       let customZigatenodeOptions = this.panel.config['zigatenode'];
        if(typeof(customZigatenodeOptions) === 'Object')
          this._zigateNodeOptions = Object.assign(this._zigateNodeOptions, customZigatenodeOptions);
     
        let customMissingNodeOptions = this.panel.config['missing'];
        if(typeof(customMissingNodeOptions) === 'Object')
          this._missingNodeOptions = Object.assign(this._missingNodeOptions, customMissingNodeOptions);

      }

      initNetworkGraph() {
        let container = this.$.zigatenetworkmap;
        let data = {
          nodes: this._nodesDataset,
          edges: this._edgesDataset
        }
        this._networkGraph = new vis.Network(container, data, this._graphOptions);
        this._networkGraph.on('stabilized', function () {
            this._networkGraph.setOptions( { physics: false } );
        }.bind(this));
      }

      refreshData() {
        this._edgesDataset.clear();
        this._nodesDataset.clear();

        let myzigate = this.hass.states['zigate.zigate'];
        let zigateDevicesStates = new Array();

        for (let state in this.hass.states) {
          if (state.indexOf('zigate.') === 0)
            zigateDevicesStates.push(this.hass.states[state]);
        }        

        zigateDevicesStates.forEach(function (entity) {
          let entityAddr = entity.attributes.addr;
          let entityMissing = entity.attributes.missing;
          let node = {
            id: entity.attributes.addr
            , label: entity.attributes.friendly_name
            , title: '<strong>' + entity.attributes.friendly_name
              + '</strong><br>IEEE : ' + entity.attributes.ieee
              + '</strong><br>ADDR : ' + entity.attributes.addr
            , value: 5
          };

          if (entityAddr === '0000') {
          	 node = Object.assign(node, this._zigateNodeOptions);
          }

          if (entityMissing === true) {
          	 node = Object.assign(node, this._missingNodeOptions);
          }
  
          this._nodesDataset.add(node);
        }.bind(this));       

        var sameLinks = [];

        myzigate.attributes.network_table.forEach(function (link) {
          //count links on same objects to avoid overlapping edge labels
          var sameLinkKey = [link[0], link[1]].sort().join()
          if(typeof(sameLinks[sameLinkKey]) === 'undefined')
            sameLinks[sameLinkKey] = 1;
          else 
            sameLinks[sameLinkKey]++;

          if (link[0] != link[1]) {
            let edge = {
              from: link[0]
              ,to: link[1]
              ,value: link[2]
              ,title: 'lqi: ' + link[2].toString()
              ,label: link[2].toString()
             // ,smooth: { enabled: sameLinks[sameLinkKey] > 1, type: 'dynamic' }
            };
            this._edgesDataset.add(edge);
          }
        }.bind(this));

        console.dir(sameLinks);

        this._networkGraph.setOptions({ physics: { enabled: true} });
        this._edgesDataset.flush(); 
        this._nodesDataset.flush();
          

     //   if(typeof(this._networkGraph) !== 'undefined')
          this._networkGraph.stabilize();     
      }
    }

    customElements.define(HaPanelZiGate.is, HaPanelZiGate);
  </script>